<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Документы</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { background-color: #f8f9fa; padding: 2rem; }
        .tree { font-family: monospace; }
        .tree { list-style: none; padding-left: 1rem; }
        .tree li { margin: 0.3rem 0; cursor: pointer; }
        .file-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        .file-table col:nth-child(1) { width: auto; }
        .file-table col:nth-child(2) { width: 180px; }
        .file-table col:nth-child(3),
        .file-table col:nth-child(4) { width: 150px; }
        .file-table td { padding: 0.2rem 0.5rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .file-table tr.row-odd { background-color: #ffffff; }
        .file-table tr.row-even { background-color: #e9ecef; }
        .status-icons i { margin-right: 0.3rem; }
        .folder-title {
            background-color: #d0e7ff; /* светло-голубой фон только для строки с названием */
            padding: 0.1rem 0.1rem; /* увеличиваем вертикальный отступ */
            display: flex; /* чтобы иконка и текст оставались на одной линии */
            align-items: center; /* вертикальное выравнивание по центру */
        }

        .folder i {
            margin-left: 5px; /* отступ перед иконкой */
            margin-right: 10px; /* чтобы иконка не прилипала к тексту */
            transition: color 0.2s;
        }
        /* Фильтры */
        .filter-row { margin-bottom: 1rem; }
        .filter-row input { width: 100%; }
        .badge-count {
            background-color: #f8f9fa; /* светлый фон */
            color: #212529; /* темный текст */
            font-weight: 500;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
        }

    </style>
</head>
<body>
<div class="container">
    <a th:href="@{/projects/{id}(id=${project.id})}" class="btn btn-outline-primary mb-3">
        <i class="bi bi-arrow-left"></i> К проекту
    </a>


    <!-- Фильтры -->
    <form th:action="@{/projects/{id}/documents(id=${project.id})}" method="get" class="row g-2 mb-3 filter-row">
        <div class="col-5">
            <input type="text" name="filename" class="form-control" placeholder="Файл" th:value="${searchParams.filename}">
        </div>
        <div class="col-2">
            <input type="text" name="status" class="form-control" placeholder="Статус" th:value="${searchParams.status}">
        </div>
        <div class="col-2">
            <input type="text" name="lastModify" class="form-control" placeholder="Последний подписавший" th:value="${searchParams.lastModify}">
        </div>
        <div class="col-2">
            <input type="text" name="responsible" class="form-control" placeholder="Ответственный" th:value="${searchParams.responsible}">
        </div>
        <div class="col-1">
            <button type="submit" class="btn btn-primary w-100">Поиск</button>
        </div>
    </form>


    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <div><i class="bi bi-folder"></i> Документы</div>
            <div class="badge badge-count" id="total-count">
                <i class="bi bi-list-check"></i> Всего: 0
            </div>
        </div>
        <div class="card-body">
            <ul id="docTree" class="tree">
                <!-- JS построит дерево -->
            </ul>
        </div>
    </div>
</div>

<script th:inline="javascript">
    const docs = /*[[${docs}]]*/ [];

    const statusIcons = {
        'UNDEFINED': 'bi-hourglass text-secondary',
        'MARKED_AS_READY': 'bi-check-circle text-info',
        'READY': 'bi-check-circle text-success',
        'NOT_READY': 'bi-x-circle text-danger',
        'CHECKER_MARKED_AS_NOT_READY': 'bi-x-circle text-danger',
        'CHECKER_MARKED_AS_READY': 'bi-check-circle text-success',
        'STANDARD_CONTROL_MARKED_AS_NOT_READY': 'bi-x-circle text-danger',
        'STANDARD_CONTROL_MARKED_AS_READY': 'bi-check-circle text-success',
        'TECHNICAL_CONTROL_MARKED_AS_NOT_READY': 'bi-x-circle text-danger',
        'TECHNICAL_CONTROL_MARKED_AS_READY': 'bi-check-circle text-success',
        'APPROVED_MARKED_AS_NOT_READY': 'bi-x-circle text-danger',
        'APPROVED_MARKED_AS_READY': 'bi-check-circle text-success'
    };

    function normalizeStatus(status) {
        if (status === 'UNDEFINED' || status === 'MARKED_AS_READY') return status;
        return status.endsWith('NOT_READY') ? 'NOT_READY' : 'READY';
    }

    const summaryIcons = {
        'UNDEFINED': 'bi-hourglass text-secondary',
        'MARKED_AS_READY': 'bi-check-circle text-info',
        'READY': 'bi-check-circle text-success',
        'NOT_READY': 'bi-x-circle text-danger'
    };

    function buildTree(docs) {
        const root = {};
        docs.forEach(doc => {
            // Применяем фильтры
            const filenameFilter = document.querySelector('input[name="filename"]').value.toLowerCase();
            const statusFilter = document.querySelector('input[name="status"]').value.toLowerCase();
            const lastModifyFilter = document.querySelector('input[name="lastModify"]').value.toLowerCase();
            const responsibleFilter = document.querySelector('input[name="responsible"]').value.toLowerCase();

            if ((doc.clientFilePath || '').toLowerCase().includes(filenameFilter)
                && (doc.statusDisplayName || '').toLowerCase().includes(statusFilter)
                && (doc.lastModifyDisplayName || '').toLowerCase().includes(lastModifyFilter)
                && (doc.responsibleDisplayName || '').toLowerCase().includes(responsibleFilter)) {

                const path = doc.clientFilePath?.split(/[\\/]/) || [];
                let node = root;
                path.forEach((part, idx) => {
                    if (!node[part]) node[part] = { __children: {}, __files: [] };
                    if (idx === path.length - 1) node[part].__files.push(doc);
                    node = node[part].__children;
                });
            }
        });
        return root;
    }

    let globalFileRowIndex = 0;
    function renderTree(node, parentEl) {
        // Разделяем ключи на папки и файлы
        const folderKeys = [];
        const fileKeys = [];

        Object.keys(node).forEach(key => {
            if (node[key].__files.length > 0) {
                fileKeys.push(key);
            } else {
                folderKeys.push(key);
            }
        });

        // Сортируем по алфавиту
        folderKeys.sort((a, b) => a.localeCompare(b));
        fileKeys.sort((a, b) => a.localeCompare(b));

        // Сначала рендерим папки
        folderKeys.forEach(key => {
            const entry = node[key];
            const li = document.createElement('li');
            li.classList.add('folder');

            const titleDiv = document.createElement('div');
            titleDiv.classList.add('folder-title');

            const icon = document.createElement('i');
            icon.classList.add('bi', 'bi-folder2-open', 'text-primary');
            titleDiv.appendChild(icon);

// Название папки
            const nameSpan = document.createElement('span');
            nameSpan.textContent = ` ${key} `;
            titleDiv.appendChild(nameSpan);

// Статус-иконки
            const statusSpan = document.createElement('span');
            statusSpan.classList.add('status-icons');
            titleDiv.appendChild(statusSpan);

            li.appendChild(titleDiv);

            const ul = document.createElement('ul');
            ul.classList.add('tree');
            renderTree(entry.__children, ul);
            li.appendChild(ul);

            // Считаем статусы
            const counts = { 'UNDEFINED': 0, 'MARKED_AS_READY': 0, 'READY': 0, 'NOT_READY': 0 };
            (function countStatuses(n) {
                Object.values(n).forEach(e => {
                    e.__files.forEach(f => {
                        const st = normalizeStatus(f.statusName);
                        counts[st]++;
                    });
                    countStatuses(e.__children);
                });
            })(entry.__children);

            Object.entries(counts).forEach(([s, c]) => {
                if (c > 0) statusSpan.innerHTML += ` <i class="bi ${summaryIcons[s]}"></i>${c}`;
            });

            icon.addEventListener('click', e => {
                e.stopPropagation();
                ul.classList.toggle('d-none');
                if (ul.classList.contains('d-none')) {
                    icon.classList.remove('bi-folder2-open', 'text-primary');
                    icon.classList.add('bi-folder2', 'text-secondary');
                } else {
                    icon.classList.remove('bi-folder2', 'text-secondary');
                    icon.classList.add('bi-folder2-open', 'text-primary');
                }
            });

            parentEl.appendChild(li);
        });

        // Потом рендерим файлы
        fileKeys.forEach(key => {
            const entry = node[key];
            const li = document.createElement('li');

            const table = document.createElement('table');
            table.classList.add('file-table');

            const colgroup = document.createElement('colgroup');
            colgroup.innerHTML = `<col><col><col><col>`;
            table.appendChild(colgroup);

            entry.__files.forEach(file => {
                const row = document.createElement('tr');
                row.classList.add(globalFileRowIndex % 2 === 0 ? 'row-odd' : 'row-even');
                globalFileRowIndex++;

                row.innerHTML = `
                <td><img src="/img/file-icon.png" class="file-icon"> ${key}</td>
                <td class="status-icons"><i class="bi ${statusIcons[file.statusName]}"></i> ${file.statusDisplayName}</td>
                <td>${file.lastModifyDisplayName}</td>
                <td>${file.responsibleDisplayName}</td>
            `;
                table.appendChild(row);
            });

            li.appendChild(table);
            parentEl.appendChild(li);
        });
    }
    document.addEventListener('DOMContentLoaded', () => {
        const tree = buildTree(docs);
        renderTree(tree, document.getElementById('docTree'));

        // Считаем общее количество файлов
        let totalFiles = 0;
        docs.forEach(doc => totalFiles++);
        document.getElementById('total-count').querySelector('span')?.remove(); // удаляем старый span
        document.getElementById('total-count').innerHTML = `<i class="bi bi-list-check"></i> Всего: ${totalFiles}`;
    });
</script>
</body>
</html>
